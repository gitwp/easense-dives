<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   creationComplete="handleCreationComplete(event)">
	<s:states>
		<s:State name="State1"/>
		<s:State name="cartView"/>
		<s:State name="expanded"/>
	</s:states>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
		<fx:XML id="groceryInventory" source="assets/inventory.xml"/>

		<s:HTTPService id="categoryService"
					   url="http://www.flexgrocer.com/category.xml"
					   resultFormat="e4x"
					   result="handleCategoryResult(event)"/>
	</fx:Declarations>

	<fx:Script>
		<![CDATA[
			import cart.ShoppingCart;
			import cart.ShoppingCartItem;
			
			import mx.collections.XMLListCollection;
			import mx.events.FlexEvent;
			import mx.rpc.events.ResultEvent;
			
			import valueObjects.Product;			
			
			[Bindable]
			public var shoppingCart:ShoppingCart = new ShoppingCart();

			[Bindable]
			private var theProduct:Product;

			[Bindable]
			private var categories:XMLListCollection;

			private function handleViewCartClick(event:MouseEvent):void {
				this.currentState="cartView";
			}

			private function addToCart(event:MouseEvent, product:Product):void {
				var sci:ShoppingCartItem = new ShoppingCartItem(product);
				shoppingCart.addItem(sci);
				trace(shoppingCart);
			}

			private function handleCreationComplete(event:FlexEvent):void {
				theProduct = Product.buildProduct(groceryInventory);

				trace(theProduct);
				categoryService.send();
			}
			
			private function handleCategoryResult(event:ResultEvent):void{
				categories = new XMLListCollection(event.result.category);
			}
		]]>
	</fx:Script>

	<s:controlBarLayout>
		<s:BasicLayout/>
	</s:controlBarLayout>
	
	<s:controlBarContent>
		<s:Button y="10" label="Checkout" id="btnCheckout" right="10"/>
		<s:Button y="10" label="View Cart" id="btnCartView" right="90" click.State1="handleViewCartClick(event)"/>
		<s:Button label="Flex Grocer" x="5" y="5"/>
		<s:List left="200" height="40" dataProvider="{categories}" labelField="name">
			<s:layout>
				<s:HorizontalLayout/>
			</s:layout>
		</s:List>
	</s:controlBarContent>
	<s:Label text="(c) 2009, FlexGrocer" right="10" bottom="10"/>
	<s:HGroup x="0" y="0" width="100%" height="100%" id="bodyGroup">
		<s:VGroup width="100%" height="150" id="products" width.cartView="0" height.cartView="0" visible.cartView="false">
			<s:Label text="Milk" id="prodName"/>
			<mx:Image source="@Embed('assets/dairy_milk.jpg')" scaleContent="true" 
					  mouseOver="this.currentState='expanded'"
					  mouseOut="this.currentState='State1'"/>
			<s:Label text="$1.99" id="price"/>
			<s:Button label="AddToCart" id="add"
					  click="addToCart(event, theProduct)"/>
		</s:VGroup>
		<s:VGroup height="100%" id="cartGroup" width.cartView="100%">
			<s:Label text="Your Cart Total: ${shoppingCart.total}"/>
			<s:Button label="View Cart" click="handleViewCartClick(event)" includeIn="State1"/>
			<mx:DataGrid includeIn="cartView" id="dgCart" width="100%">
				<mx:columns>
					<mx:DataGridColumn headerText="Column 1" dataField="col1"/>
					<mx:DataGridColumn headerText="Column 2" dataField="col2"/>
					<mx:DataGridColumn headerText="Column 3" dataField="col3"/>
				</mx:columns>
			</mx:DataGrid>
			<s:Button includeIn="cartView" label="Continue Shopping" click="this.currentState=''"/>
		</s:VGroup>
	</s:HGroup>
	<s:VGroup includeIn="expanded" x="200" width="100%">
		<s:RichText text="{theProduct.description}" width="50%"/>
		<s:Label text="Certified Organic"
				 visible="{theProduct.isOrganic}"/>
		<s:Label text="Low Fat"
				 visible="{theProduct.isLowFat}"/>
	</s:VGroup>

</s:Application>
